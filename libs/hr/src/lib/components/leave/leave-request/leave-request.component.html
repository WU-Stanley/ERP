<div class="min-h-screen bg-gray-100 px-6">
  <nav class="text-sm text-gray-500 mb-2">
    Home / HR / Leave /<span class="text-gray-700 font-medium"
      >Leave Requests</span
    >
  </nav>
  <div class="flex justify-between">
    <h1 class="text-2xl font-bold text-gray-800">My Leave Requests</h1>
    <lib-add-button
      label="Request for Leave"
      (submitAction)="toggleLeaveRequestForm()"
    ></lib-add-button>
  </div>
  @if(recentLeaveRequestType !==null) {
  <div class="flex flex-wrap gap-2 mt-2 mb-2">
    <div class="bg-white shadow-md rounded-lg p-4 mb-4">
      <h3 class="block font-medium">Review Status</h3>
      <div class="flex gap-4 justify-between">
        <div class="flex flex-col">
          <div>
            Leave Type:<span class="font-medium">
              {{ recentLeaveRequestType?.leaveType?.name }}</span
            >
          </div>
          <div>
            <span>Start Date:</span
            ><span class="font-medium">
              {{
                recentLeaveRequestType?.startDate | date : 'yyyy-MM-dd'
              }}</span
            >
          </div>
          <div>
            <span>End Date:</span
            ><span class="font-medium">
              {{ recentLeaveRequestType?.endDate | date : 'yyyy-MM-dd' }}</span
            >
          </div>

          <div>
            <span>Total Days:</span
            ><span class="font-medium">
              {{ recentLeaveRequestType?.totalDays + ' days' }}</span
            >
          </div>
          <div>
            <span>Reason:</span
            ><span class="font-medium">
              {{ recentLeaveRequestType?.reason }}</span
            >
          </div>
        </div>
        <div style="width: 1px; height: 130px; background-color: #ccc"></div>

        <div class="flex flex-col">
          <div>
            Status:<span class="font-medium">
              {{ recentLeaveRequestType?.status }}</span
            >
          </div>
          <div>
            <h3 class="text-sm text-gray-500">Approval Flow</h3>

            @if (recentLeaveRequestType?.leaveType?.approvalFlow?.steps?.length)
            {
            <ol
              class="list-inside text-sm space-y-3 flex items-center justify-center"
            >
              <li
                class="text-gray-700 text-sm mt-1 items-center justify-center"
                *ngFor="
                  let step of recentLeaveRequestType?.leaveType?.approvalFlow
                    ?.steps;
                  let i = index
                "
              >
                <!-- Approver Info -->
                <div>
                  <span class="font-medium">
                    {{
                      step.approverValue.length > 2
                        ? step.approverValue
                        : step.approverType
                    }}
                  </span>
                  <span
                    *ngIf="
                      i <
                      (recentLeaveRequestType?.leaveType?.approvalFlow?.steps
                        ?.length || 0) -
                        1
                    "
                  >
                    {{ '=>' }}
                  </span>
                </div>
              </li>
            </ol>
            } @else {
            <p class="font-medium">No approval flow defined.</p>
            }
          </div>
          <div>
            <span>Duration:</span
            ><span class="font-medium">
              {{ recentLeaveRequestType?.totalDays + ' working days' }}</span
            >
          </div>
          <div class="flex gap-2 mt-2">
            <lib-flat-button
              (submitAction)="deleteLeave(recentLeaveRequestType)"
              label="Withdraw Request"
            >
            </lib-flat-button>
            <lib-submit-rounded-button
              label="Edit Request"
              (click)="editLeave(recentLeaveRequestType)"
            >
            </lib-submit-rounded-button>
          </div>
        </div>
      </div>
    </div>
    <div class="bg-white shadow-md rounded-lg p-4 mb-4 w-[380px]">
      <h3 class="block font-medium">Feedback from Manager</h3>
      <div class="flex gap-4">
        <div class="flex flex-col"></div>
        <!-- <div style="width: 1px; height: 130px; background-color: #ccc"></div> -->

        <div class="flex flex-col">
          <div class="border p-4">No feedback from manager yet!</div>
        </div>
      </div>
    </div>
  </div>
  }
  <ng-container *ngIf="leaveRequests().length > 0; else noLeaveRequests">
    <table class="min-w-full border border-gray-300 text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Leave Type</th>
          <th class="px-4 py-2 text-left">Start Date</th>
          <th class="px-4 py-2 text-left">End Date</th>
          <th class="px-4 py-2 text-left">Total Days</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-left">Date Applied</th>
          <th class="px-4 py-2 text-left">Reason</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 bg-white">
        <tr
          *ngFor="let leave of leaveRequests(); let i = index"
          [ngClass]="{ 'bg-gray-50': i % 2 === 0 }"
          class="transition border-t hover:bg-gray-100"
        >
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.leaveType!.name }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.startDate | date : 'yyyy-MM-dd' }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.endDate | date : 'yyyy-MM-dd' }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.totalDays }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.status }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.appliedAt | date : 'short' }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">
            {{ leave.reason | wordSlice : 10 }}
          </td>
          <td class="px-4 py-3 font-medium text-gray-800 relative">
            <button
              (click)="toggleMenu(i)"
              class="p-2 rounded hover:bg-gray-200"
              aria-label="Actions"
            >
              <span class="material-symbols-outlined ml-auto">more_vert</span>
            </button>
            <div
              *ngIf="showMenu && activeMenuIndex === i"
              class="absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded shadow-lg z-10"
            >
              <button
                (click)="editLeave(leave)"
                class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-blue-600"
              >
                Edit
              </button>
              <button
                (click)="deleteLeave(leave)"
                class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600"
              >
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>
  <ng-template #noLeaveRequests>
    <div class="p-4 text-gray-500 text-2xl">
      You have no leave requests yet.
    </div>
  </ng-template>
  <ng-container *ngIf="showRequestForm">
    <lib-leave-request-form
      (closeFormEvent)="toggleLeaveRequestForm()"
    ></lib-leave-request-form>
  </ng-container>
</div>
